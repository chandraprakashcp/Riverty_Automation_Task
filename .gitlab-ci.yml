stages:
  - test

variables:
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"

tagged-tests:
  stage: test
  script:
    - echo "Running tests with tag: ${TEST_TAG}"
    - echo "Building Docker image..."
    - docker build -t booking-api-tests .
    - echo "Creating test reports directory..."
    - mkdir -p "test-reports-${TEST_TAG}"
    - echo "Executing tests with filter: Category=${TEST_TAG}"
    - docker run --rm -v "${PWD}/test-reports-${TEST_TAG}:/app/bin/Release/net6.0/TestReports" booking-api-tests --filter "Category=${TEST_TAG}"
    - echo "Test execution completed for ${TEST_TAG} tests"
  after_script:
    - echo "Checking generated reports..."
    - powershell "if (Test-Path 'test-reports-${TEST_TAG}') { Write-Host 'Reports found:'; Get-ChildItem 'test-reports-${TEST_TAG}' } else { Write-Host 'No test reports found' }"
  artifacts:
    when: always
    paths:
      - "test-reports-${TEST_TAG}/"
    expire_in: 1 week
  tags:
    - api